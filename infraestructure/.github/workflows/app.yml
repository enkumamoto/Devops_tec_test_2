name: Application CI/CD

on:
  push:
    branches:
      - main
    paths:
      - "infraestructure/app/**"
      - "infraestructure/k8s/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      ACR_NAME: ${{ secrets.ACR_NAME }}
      AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP }}
      AKS_CLUSTER_NAME: ${{ secrets.AKS_CLUSTER_NAME }}

      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # üîê Login Azure
      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"

          az account set \
            --subscription "$ARM_SUBSCRIPTION_ID"

      # üê≥ Login no ACR
      - name: Login to ACR
        run: az acr login --name $ACR_NAME

      # üê≥ Build & Push
      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=$(git rev-parse --short HEAD)

          docker build \
            -t $ACR_NAME.azurecr.io/devops-fastapi:$IMAGE_TAG \
            infraestructure/app

          docker push \
            $ACR_NAME.azurecr.io/devops-fastapi:$IMAGE_TAG

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # ‚ò∏Ô∏è AKS credentials
      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group $AKS_RESOURCE_GROUP \
            --name $AKS_CLUSTER_NAME \
            --overwrite-existing

      # ‚ò∏Ô∏è Deploy
      - name: Deploy to AKS
        run: |
          sed -i "s|IMAGE_TAG|$IMAGE_TAG|g" infraestructure/k8s/deployment.yaml
          kubectl apply -f infraestructure/k8s/
