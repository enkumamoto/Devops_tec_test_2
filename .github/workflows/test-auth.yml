name: Test Azure Authentication

on:
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug output"
        required: false
        type: boolean
        default: false

jobs:
  test-auth:
    runs-on: ubuntu-latest
    environment: test
    
    steps:
      # === PASSO CR√çTICO ADICIONADO ===
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Pega todo o hist√≥rico
      
      - name: Check Azure Secrets
        run: |
          echo "üîê Testing Azure authentication..."
          echo "======================================"
          
          # Check each secret (without revealing values)
          SECRETS=("ARM_CLIENT_ID" "ARM_CLIENT_SECRET" "ARM_SUBSCRIPTION_ID" "ARM_TENANT_ID" "AKS_RESOURCE_GROUP")
          
          for secret in "${SECRETS[@]}"; do
            if [ -n "${{ secrets[secret] }}" ]; then
              echo "‚úÖ $secret: Configured"
            else
              echo "‚ùå $secret: MISSING"
            fi
          done
          echo ""
      
      - name: Test Azure Login
        run: |
          echo "üîë Attempting Azure login with Service Principal..."
          
          # Login usando vari√°veis de ambiente (mais seguro)
          export ARM_CLIENT_ID="${{ secrets.ARM_CLIENT_ID }}"
          export ARM_CLIENT_SECRET="${{ secrets.ARM_CLIENT_SECRET }}"
          export ARM_TENANT_ID="${{ secrets.ARM_TENANT_ID }}"
          
          az login \
            --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID" \
            --output none
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Azure login successful!"
            
            # Set subscription
            az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
            
            # Show account info
            echo ""
            echo "üìã Subscription Information:"
            az account show --query "{'Subscription Name':name, 'Subscription ID':id}" -o table
            
            # Test basic permissions
            echo ""
            echo "üîß Testing permissions..."
            RG_COUNT=$(az group list --query "length([].name)" -o tsv)
            echo "Resource Groups accessible: $RG_COUNT"
            
          else
            echo "‚ùå Azure login failed!"
            exit 1
          fi
      
      - name: Check Repository Structure
        run: |
          echo ""
          echo "üìÅ Repository structure:"
          echo "======================================"
          pwd
          ls -la
          
          if [ -d "infraestructure" ]; then
            echo "‚úÖ 'infraestructure' directory found!"
            echo ""
            echo "üì¶ Contents of infraestructure/:"
            ls -la infraestructure/
            
            # List modules
            echo ""
            echo "üîç Terraform modules found:"
            find infraestructure -maxdepth 2 -name "*.tf" | head -10
          else
            echo "‚ùå 'infraestructure' directory NOT found!"
            echo ""
            echo "‚ö†Ô∏è  Available directories:"
            find . -type d -name "*infra*" || echo "No infra directories found"
            exit 1
          fi
      
      - name: Verify Terraform Files
        if: success()
        run: |
          echo ""
          echo "üß± Verifying Terraform files..."
          echo "======================================"
          
          MODULE_COUNT=0
          for module in infraestructure/0*; do
            if [ -d "$module" ]; then
              MODULE_COUNT=$((MODULE_COUNT + 1))
              echo ""
              echo "Module: $(basename $module)"
              
              # Count .tf files
              TF_FILES=$(find "$module" -name "*.tf" | wc -l)
              echo "  .tf files: $TF_FILES"
              
              # Check critical files
              [ -f "$module/main.tf" ] && echo "  ‚úÖ main.tf" || echo "  ‚ùå main.tf (MISSING)"
              [ -f "$module/variables.tf" ] && echo "  ‚úÖ variables.tf" || echo "  ‚ùå variables.tf (MISSING)"
            fi
          done
          
          if [ $MODULE_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è  No numbered modules found (00-, 01-, etc.)"
          else
            echo ""
            echo "‚úÖ Found $MODULE_COUNT Terraform modules"
          fi
