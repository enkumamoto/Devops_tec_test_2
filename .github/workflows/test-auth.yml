name: Test Azure Authentication

on:
  workflow_dispatch:
    inputs:
      subscription_id:
        description: "Azure Subscription ID"
        required: false
        type: string

jobs:
  test-auth:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Check Azure Authentication
        run: |
          echo "üîê Testing Azure authentication..."

          # Teste b√°sico de vari√°veis
          echo "ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID != '' && '‚úÖ Set' || '‚ùå Missing' }}"
          echo "ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID != '' && '‚úÖ Set' || '‚ùå Missing' }}"
          echo "ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID != '' && '‚úÖ Set' || '‚ùå Missing' }}"
          echo "AKS_RESOURCE_GROUP: ${{ secrets.AKS_RESOURCE_GROUP != '' && '‚úÖ Set' || '‚ùå Missing' }}"

          # Teste de login real
          echo "üîë Attempting Azure login..."
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}" \
            --output none

          if [ $? -eq 0 ]; then
            echo "‚úÖ Azure login successful!"
            
            # Mostrar subscription info
            az account show --query "{name:name, id:id}" -o table
            
            # Testar permiss√µes b√°sicas
            echo "üìã Testing permissions..."
            az group list --query "length([].name)" -o tsv | xargs -I {} echo "Resource Groups accessible: {}"
            
          else
            echo "‚ùå Azure login failed!"
            exit 1
          fi

      - name: Validate Terraform Configuration
        run: |
          echo "üß± Checking Terraform files..."

          # Verificar estrutura dos m√≥dulos
          if [ -d "infraestructure" ]; then
            echo "‚úÖ infraestructure directory exists"
            ls -la infraestructure/
          else
            echo "‚ùå infraestructure directory not found"
            exit 1
          fi
