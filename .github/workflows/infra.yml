name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      tf_action:
        description: "Terraform action"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  TF_ACTION: ${{ github.event.inputs.tf_action }}

jobs:
  # =========================
  # 1. OBTER BACKEND DO BOOTSTRAP
  # =========================
  setup:
    runs-on: ubuntu-latest
    outputs:
      tf_rg: ${{ steps.get-backend.outputs.tf_rg }}
      tf_sa: ${{ steps.get-backend.outputs.tf_sa }}
      tf_container: ${{ steps.get-backend.outputs.tf_container }}

    steps:
      - name: Get Bootstrap Backend Info
        id: get-backend
        run: |
          # Para o primeiro deploy, obtenha das secrets ou vari√°veis
          ENV="${{ github.event.inputs.environment }}"

          if [ -n "${{ secrets.TF_STATE_RESOURCE_GROUP }}" ]; then
            echo "Using secrets for backend..."
            echo "tf_rg=${{ secrets.TF_STATE_RESOURCE_GROUP }}" >> $GITHUB_OUTPUT
            echo "tf_sa=${{ secrets.TF_STATE_STORAGE_ACCOUNT }}" >> $GITHUB_OUTPUT
            echo "tf_container=${{ secrets.TF_STATE_CONTAINER }}" >> $GITHUB_OUTPUT
          else
            # Se n√£o houver secrets, use valores padr√£o baseados no ambiente
            echo "Using default backend names..."
            echo "tf_rg=rg-terraform-state-$ENV" >> $GITHUB_OUTPUT
            echo "tf_sa=tfstate${ENV}devops" >> $GITHUB_OUTPUT
            echo "tf_container=tfstate" >> $GITHUB_OUTPUT
          fi

          echo "Backend configuration:"
          echo "RG: ${{ steps.get-backend.outputs.tf_rg }}"
          echo "SA: ${{ steps.get-backend.outputs.tf_sa }}"
          echo "Container: ${{ steps.get-backend.outputs.tf_container }}"

  # =========================
  # 2. NETWORK - Primeiro m√≥dulo
  # =========================
  network:
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
          echo "‚úÖ Azure login successful"

      - name: Terraform Init - Network
        working-directory: infraestructure/01-network
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=network.tfstate" \
            -input=false \
            -reconfigure

      - name: Terraform Plan - Network
        working-directory: infraestructure/01-network
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=eastus" \
            -out=tfplan \
            -input=false

      - name: Terraform Apply - Network
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/01-network
        run: terraform apply tfplan -input=false

  # =========================
  # 3. ACR - Segundo m√≥dulo (depende apenas do backend)
  # =========================
  acr:
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Terraform Init - ACR
        working-directory: infraestructure/02-acr
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=acr.tfstate" \
            -input=false \
            -reconfigure

      - name: Terraform Plan - ACR
        working-directory: infraestructure/02-acr
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=eastus" \
            -out=tfplan \
            -input=false

      - name: Terraform Apply - ACR
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/02-acr
        run: terraform apply tfplan -input=false

  # =========================
  # 4. AKS - Terceiro m√≥dulo (depende de network e acr)
  # =========================
  aks:
    runs-on: ubuntu-latest
    needs: [network, acr]
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Terraform Init - AKS
        working-directory: infraestructure/03-aks
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=aks.tfstate" \
            -input=false \
            -reconfigure

      - name: Terraform Plan - AKS
        working-directory: infraestructure/03-aks
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=eastus" \
            -out=tfplan \
            -input=false

      - name: Terraform Apply - AKS
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/03-aks
        run: terraform apply tfplan -input=false

  # =========================
  # 5. DATABASE - Quarto m√≥dulo (depende de network)
  # =========================
  database:
    runs-on: ubuntu-latest
    needs: network
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Terraform Init - Database
        working-directory: infraestructure/05-database
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=database.tfstate" \
            -input=false \
            -reconfigure

      - name: Terraform Plan - Database
        working-directory: infraestructure/05-database
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=eastus" \
            -out=tfplan \
            -input=false

      - name: Terraform Apply - Database
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/05-database
        run: terraform apply tfplan -input=false

  # =========================
  # 6. BASTION - Quinto m√≥dulo (depende de network)
  # =========================
  bastion:
    runs-on: ubuntu-latest
    needs: network
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Terraform Init - Bastion
        working-directory: infraestructure/04-bastion
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=bastion.tfstate" \
            -input=false \
            -reconfigure

      - name: Terraform Plan - Bastion
        working-directory: infraestructure/04-bastion
        run: |
          terraform plan \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=eastus" \
            -out=tfplan \
            -input=false

      - name: Terraform Apply - Bastion
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/04-bastion
        run: terraform apply tfplan -input=false

  # =========================
  # 7. VALIDATE & SAVE OUTPUTS
  # =========================
  validate:
    runs-on: ubuntu-latest
    needs: [network, acr, aks, database, bastion]
    if: always()

    steps:
      - name: Show Results
        run: |
          echo "üìä Deployment Results:"
          echo "Network: ${{ needs.network.result }}"
          echo "ACR: ${{ needs.acr.result }}"
          echo "AKS: ${{ needs.aks.result }}"
          echo "Database: ${{ needs.database.result }}"
          echo "Bastion: ${{ needs.bastion.result }}"

          SUCCESS_COUNT=0
          TOTAL_COUNT=5

          if [ "${{ needs.network.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.acr.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.aks.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.database.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.bastion.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi

          echo ""
          echo "üéØ Summary: $SUCCESS_COUNT/$TOTAL_COUNT modules succeeded"

          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "‚úÖ All infrastructure modules deployed successfully!"
          else
            echo "‚ö†Ô∏è  Some modules failed. Check the logs above."
          fi
