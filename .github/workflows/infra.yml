name: Terraform Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      tf_action:
        description: "Terraform action"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  TF_ACTION: ${{ github.event.inputs.tf_action }}

  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

jobs:
  # =====================================================
  # 1. BACKEND BOOTSTRAP (Storage Account + Key)
  # =====================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      tf_rg: ${{ steps.backend.outputs.tf_rg }}
      tf_sa: ${{ steps.backend.outputs.tf_sa }}
      tf_container: ${{ steps.backend.outputs.tf_container }}
      sas_token: ${{ steps.backend.outputs.sas_token }}

    steps:
      - name: Azure Login (Service Principal)
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Create RG + Storage Account + Container
        id: backend
        run: |
          ENV="${{ github.event.inputs.environment }}"

          RG="rg-terraform-state-${ENV}"
          SA="tfstate${ENV}devops"
          CONTAINER="tfstate"
          LOCATION="canadacentral"

          az group create \
            --name "$RG" \
            --location "$LOCATION"

          az storage account create \
            --name "$SA" \
            --resource-group "$RG" \
            --location "$LOCATION" \
            --sku Standard_LRS \
            --kind StorageV2 \
            --https-only true \
            --allow-blob-public-access false

          SA_KEY=$(az storage account keys list \
            --resource-group "$RG" \
            --account-name "$SA" \
            --query "[0].value" -o tsv)

          az storage container create \
            --name "$CONTAINER" \
            --account-name "$SA" \
            --account-key "$SA_KEY" \
            --public-access off

          SAS_TOKEN=$(az storage container generate-sas \
            --name "$CONTAINER" \
            --account-name "$SA" \
            --account-key "$SA_KEY" \
            --permissions "rlwcd" \
            --expiry "2026-12-31" \
            --https-only \
            --output tsv)

          if [ -z "$SAS_TOKEN" ]; then
            echo "Erro: SAS_TOKEN est√° vazio. Verifique permiss√µes do SP no Storage Account."
            exit 1
          fi

          echo "::add-mask::$SAS_TOKEN"
          echo "tf_rg=$RG" >> $GITHUB_OUTPUT
          echo "tf_sa=$SA" >> $GITHUB_OUTPUT
          echo "tf_container=$CONTAINER" >> $GITHUB_OUTPUT
          echo "sas_token=$SAS_TOKEN" >> $GITHUB_OUTPUT

  # =====================================================
  # 2. NETWORK
  # =====================================================
  network:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout repository (with retry)
        uses: actions/checkout@v3
        continue-on-error: false

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init - Network
        working-directory: infraestructure/01-network
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=network.tfstate" \
            -backend-config="sas_token=${{ needs.setup.outputs.sas_token }}" \
            -reconfigure \
            -input=false

      - name: Terraform Plan - Network
        working-directory: infraestructure/01-network
        run: terraform plan -input=false

      - name: Terraform Apply - Network
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/01-network
        run: terraform apply -auto-approve -input=false

  # =====================================================
  # 3. ACR
  # =====================================================
  acr:
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init - ACR
        working-directory: infraestructure/02-acr
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=acr.tfstate" \
            -backend-config="sas_token=${{ needs.setup.outputs.sas_token }}" \
            -reconfigure \
            -input=false

      - name: Terraform Plan - ACR
        working-directory: infraestructure/02-acr
        run: terraform plan -input=false

      - name: Terraform Apply - ACR
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/02-acr
        run: terraform apply -auto-approve -input=false

  # =====================================================
  # 4. AKS
  # =====================================================
  aks:
    runs-on: ubuntu-latest
    needs: [setup, network, acr]
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Azure Login
        run: |
          az login --service-principal \
            -u "${{ secrets.ARM_CLIENT_ID }}" \
            -p "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"
          az account set -s "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Import existing Key Vault state resources (dynamic)
        working-directory: infraestructure/03-aks
        run: |
          # Vari√°veis base
          SUBSCRIPTION_ID="${{ secrets.ARM_SUBSCRIPTION_ID }}"
          RESOURCE_GROUP="rg-aks-dev"
          KEYVAULT_NAME="kv-aks-devops-dev"
          CLIENT_ID="${{ secrets.ARM_CLIENT_ID }}"

          echo "üîé Obtendo ObjectID do KV para policy Terraform"
          OBJECT_ID=$(az keyvault show --name "$KEYVAULT_NAME" --resource-group "$RESOURCE_GROUP" --query "properties.accessPolicies[?applicationId=='$CLIENT_ID'].objectId | [0]" -o tsv)

          if [ -z "$OBJECT_ID" ]; then
            echo "‚ö†Ô∏è ObjectID n√£o encontrado"
          else
            terraform import azurerm_key_vault_access_policy.terraform "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEYVAULT_NAME/objectId/$OBJECT_ID"
          fi

          SECRET_NAMES=(
            "postgresql-host"
            "postgresql-username"
            "postgresql-password"
            "app-secret-key"
          )

          for SECRET_NAME in "${SECRET_NAMES[@]}"; do
            echo "üîé Buscando segredo $SECRET_NAME"
            SECRET_ID=$(az keyvault secret show --vault-name "$KEYVAULT_NAME" --name "$SECRET_NAME" --query "id" -o tsv || echo "")
            if [ -z "$SECRET_ID" ]; then
              echo "‚ö†Ô∏è Segredo $SECRET_NAME n√£o encontrado"
            else
              # Substituir h√≠fen por underscore para refer√™ncia correta no Terraform
              TF_RESOURCE_NAME=${SECRET_NAME//-/_}
              terraform import "azurerm_key_vault_secret.${TF_RESOURCE_NAME}" "$SECRET_ID" || echo "‚ö†Ô∏è Import falhou para $SECRET_NAME"
            fi
          done
      - name: Check and Force Unlock Terraform State (Dynamic Unlock ID)
        run: |
          echo "üîç Verificando lock no estado Terraform..."

          LEASE_ID=$(az storage blob lease show \
            --blob-name "aks.tfstate" \
            --container-name "${{ needs.setup.outputs.tf_container }}" \
            --account-name "${{ needs.setup.outputs.tf_sa }}" \
            --sas-token "${{ needs.setup.outputs.sas_token }}" \
            --query leaseId -o tsv 2>/dev/null || echo "")

          if [ -n "$LEASE_ID" ]; then
            echo "üîì Lock est√° ativo com ID $LEASE_ID. Tentando desbloquear..."

            terraform force-unlock -force "$LEASE_ID" || echo "‚ö†Ô∏è Falha no force-unlock"

            az storage blob lease break \
              --container-name "${{ needs.setup.outputs.tf_container }}" \
              --name "aks.tfstate" \
              --account-name "${{ needs.setup.outputs.tf_sa }}" \
              --sas-token "${{ needs.setup.outputs.sas_token }}" \
              --lease-break-period 0 || echo "‚ö†Ô∏è Falha ao quebrar lease"

            sleep 10
          else
            echo "‚úÖ Nenhum lock ativo encontrado."
          fi

      - name: Get ACR ID via Azure CLI
        id: get_acr
        run: |
          echo "üì¶ Obtendo ACR ID..."
          ACR_ID=$(az acr show \
            --resource-group "rg-acr-dev" \
            --name "eijidevopsdevacr" \
            --query id -o tsv 2>/dev/null || echo "")

          if [ -n "$ACR_ID" ]; then
            echo "‚úÖ ACR ID: $ACR_ID"
            echo "acr_id=$ACR_ID" >> $GITHUB_OUTPUT
            echo "ACR_ID=$ACR_ID" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è ACR n√£o encontrado"
            echo "acr_id=" >> $GITHUB_OUTPUT
            echo "ACR_ID=" >> $GITHUB_ENV
          fi

      - name: Clean Local Terraform Cache
        working-directory: infraestructure/03-aks
        run: |
          echo "üßπ Limpando cache local..."
          rm -rf .terraform .terraform.lock.hcl terraform.tfstate*

      - name: Terraform Init - AKS (Improved with Retry)
        working-directory: infraestructure/03-aks
        run: |
          echo "üöÄ Inicializando com retry..."
          for i in {1..3}; do
            if terraform init \
              -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
              -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
              -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
              -backend-config="key=aks.tfstate" \
              -backend-config="sas_token=${{ needs.setup.outputs.sas_token }}" \
              -reconfigure \
              -input=false \
              -lock=false; then
              echo "‚úÖ Init bem-sucedido na tentativa $i"
              break
            else
              echo "‚ö†Ô∏è Tentativa $i falhou. Aguardando..."
              sleep 10
            fi
          done

      - name: Terraform Plan - AKS (Simplified and Robust)
        working-directory: infraestructure/03-aks
        run: |
          echo "üìã Criando arquivo terraform.tfvars.autogen com vari√°veis para plan..."

          cat > terraform.tfvars.autogen << EOF
          environment = "dev"
          location    = "canadacentral"
          resource_group_name = "rg-aks-dev"
          aks_name   = "aks-devops"
          dns_prefix = "aks-devops-dev"
          kubernetes_version = "1.33.5"
          enable_acr_rbac = false
          acr_id = "${{ env.ACR_ID }}"
          EOF

          echo "üìã Executando terraform plan..."

          terraform plan \
            -var-file="terraform.tfvars.autogen" \
            -var="tf_backend_resource_group=${{ needs.setup.outputs.tf_rg }}" \
            -var="tf_backend_storage_account=${{ needs.setup.outputs.tf_sa }}" \
            -var="tf_backend_container=${{ needs.setup.outputs.tf_container }}" \
            -var="tf_backend_sas_token=${{ needs.setup.outputs.sas_token }}" \
            -input=false \
            -lock=false

      - name: Terraform Apply - AKS (With Enhanced Recovery)
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/03-aks
        timeout-minutes: 20
        run: |
          echo "‚ö° Aplicando AKS..."

          if terraform apply \
            -var-file="terraform.tfvars.autogen" \
            -var="tf_backend_resource_group=${{ needs.setup.outputs.tf_rg }}" \
            -var="tf_backend_storage_account=${{ needs.setup.outputs.tf_sa }}" \
            -var="tf_backend_container=${{ needs.setup.outputs.tf_container }}" \
            -var="tf_backend_sas_token=${{ needs.setup.outputs.sas_token }}" \
            -auto-approve \
            -input=false; then

            echo "‚úÖ Aplicado com sucesso!"
          else
            echo "‚ö†Ô∏è Falha com lock, tentando unlock din√¢mico e apply sem lock..."

            LEASE_ID=$(az storage blob lease show \
              --blob-name "aks.tfstate" \
              --container-name "${{ needs.setup.outputs.tf_container }}" \
              --account-name "${{ needs.setup.outputs.tf_sa }}" \
              --sas-token "${{ needs.setup.outputs.sas_token }}" \
              --query leaseId -o tsv 2>/dev/null || echo "")

            if [ -n "$LEASE_ID" ]; then
              terraform force-unlock -force "$LEASE_ID" || echo "‚ö†Ô∏è Falha no force-unlock"
            else
              echo "‚ö†Ô∏è N√£o encontrado lease ativo para unlock"
            fi

            terraform apply \
              -var-file="terraform.tfvars.autogen" \
              -var="tf_backend_resource_group=${{ needs.setup.outputs.tf_rg }}" \
              -var="tf_backend_storage_account=${{ needs.setup.outputs.tf_sa }}" \
              -var="tf_backend_container=${{ needs.setup.outputs.tf_container }}" \
              -var="tf_backend_sas_token=${{ needs.setup.outputs.sas_token }}" \
              -auto-approve \
              -input=false \
              -lock=false
          fi

      - name: Post-deploy ACR Configuration
        if: ${{ github.event.inputs.tf_action == 'apply' && env.ACR_ID != '' }}
        run: |
          echo "üîó Configurando acesso ao ACR..."
          sleep 30

          KUBELET_ID=$(az aks show \
            -g "rg-aks-dev" \
            -n "aks-devops-dev-dev" \
            --query identityProfile.kubeletidentity.objectId -o tsv 2>/dev/null || echo "")

          if [ -n "$KUBELET_ID" ]; then
            az role assignment create \
              --assignee "$KUBELET_ID" \
              --role "AcrPull" \
              --scope "${{ env.ACR_ID }}" \
              || echo "Role j√° existe"
          fi
  # =====================================================
  # 5. DATABASE
  # =====================================================
  database:
    runs-on: ubuntu-latest
    needs: [setup, network]
    if: success()

    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Azure Login for Resource Query
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Get Network IDs from Azure
        run: |
          RG_NETWORK="rg-network-dev"
          VNET_NAME="vnet"
          SUBNET_NAME="snet-dev-devops-database"

          VNET_ID=$(az network vnet show \
            --resource-group "$RG_NETWORK" \
            --name "$VNET_NAME" \
            --query id -o tsv)

          DATABASE_SUBNET_ID=$(az network vnet subnet show \
            --resource-group "$RG_NETWORK" \
            --vnet-name "$VNET_NAME" \
            --name "$SUBNET_NAME" \
            --query id -o tsv)

          if [ -z "$VNET_ID" ] || [ -z "$DATABASE_SUBNET_ID" ]; then
            echo "Erro ao obter VNET_ID ou DATABASE_SUBNET_ID"
            exit 1
          fi

          echo "VNET_ID=$VNET_ID" >> $GITHUB_ENV
          echo "DATABASE_SUBNET_ID=$DATABASE_SUBNET_ID" >> $GITHUB_ENV

      - name: Terraform Init - Database
        working-directory: infraestructure/05-database
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=database.tfstate" \
            -backend-config="sas_token=${{ needs.setup.outputs.sas_token }}" \
            -reconfigure \
            -input=false

      - name: Terraform Plan - Database
        working-directory: infraestructure/05-database
        run: |
          terraform plan \
            -var="subscription_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
            -var="location=canadacentral" \
            -var="environment=dev" \
            -var="resource_group_name=rg-database-dev" \
            -var="vnet_id=$VNET_ID" \
            -var="database_subnet_id=$DATABASE_SUBNET_ID" \
            -var="db_name=psql-devops" \
            -var="postgres_version=15" \
            -var="sku_name=B_Standard_B1ms" \
            -var="storage_mb=32768" \
            -var="backup_retention_days=7" \
            -var="geo_redundant_backup_enabled=false" \
            -var="maintenance_window={day_of_week=0,start_hour=2,start_minute=0}" \
            -var="charset=UTF8" \
            -var="collation=en_US.utf8" \
            -var="zone=1" \
            -var="high_availability_mode=Disabled" \
            -var="tags={Environment=\"dev\",Project=\"devops-technical-test\",ManagedBy=\"Terraform\",Owner=\"Platform\"}" \
            -input=false

      - name: Terraform Apply - Database
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/05-database
        run: |
          terraform apply \
            -var="subscription_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
            -var="location=canadacentral" \
            -var="environment=dev" \
            -var="resource_group_name=rg-database-dev" \
            -var="vnet_id=$VNET_ID" \
            -var="database_subnet_id=$DATABASE_SUBNET_ID" \
            -var="db_name=psql-devops" \
            -var="postgres_version=15" \
            -var="sku_name=B_Standard_B1ms" \
            -var="storage_mb=32768" \
            -var="backup_retention_days=7" \
            -var="geo_redundant_backup_enabled=false" \
            -var="maintenance_window={day_of_week=0,start_hour=2,start_minute=0}" \
            -var="charset=UTF8" \
            -var="collation=en_US.utf8" \
            -var="zone=1" \
            -var="high_availability_mode=Disabled" \
            -var="tags={Environment=\"dev\",Project=\"devops-technical-test\",ManagedBy=\"Terraform\",Owner=\"Platform\"}" \
            -auto-approve \
            -input=false

  # =====================================================
  # 6. BASTION
  # =====================================================
  bastion:
    runs-on: ubuntu-latest
    needs: [setup, network]

    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Init - Bastion
        working-directory: infraestructure/04-bastion
        run: |
          terraform init \
            -backend-config="resource_group_name=${{ needs.setup.outputs.tf_rg }}" \
            -backend-config="storage_account_name=${{ needs.setup.outputs.tf_sa }}" \
            -backend-config="container_name=${{ needs.setup.outputs.tf_container }}" \
            -backend-config="key=bastion.tfstate" \
            -backend-config="sas_token=${{ needs.setup.outputs.sas_token }}" \
            -reconfigure \
            -input=false

      - name: Terraform Plan - Bastion
        working-directory: infraestructure/04-bastion
        run: |
          terraform plan \
            -var="subscription_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
            -var="vnet_id=${{ needs.network.outputs.vnet_id }}" \
            -var="bastion_subnet_id=${{ needs.network.outputs.bastion_subnet_id }}" \
            -var="aks_subnet_cidr=${{ needs.network.outputs.aks_subnet_address_prefixes[0] }}" \
            -var="tf_backend_resource_group=${{ needs.setup.outputs.tf_rg }}" \
            -var="tf_backend_storage_account=${{ needs.setup.outputs.tf_sa }}" \
            -var="tf_backend_container=${{ needs.setup.outputs.tf_container }}" \
            -var="tf_backend_sas_token=${{ needs.setup.outputs.sas_token }}" \
            -input=false

      - name: Debug Bastion Subnet ID
        run: |
          echo "Bastion Subnet ID recebido: '${{ needs.network.outputs.bastion_subnet_id }}'"

      - name: Terraform Apply - Bastion
        if: ${{ github.event.inputs.tf_action == 'apply' }}
        working-directory: infraestructure/04-bastion
        run: |
          terraform apply \
            -var="subscription_id=${{ secrets.ARM_SUBSCRIPTION_ID }}" \
            -var="vnet_id=${{ needs.network.outputs.vnet_id }}" \
            -var="bastion_subnet_id=${{ needs.network.outputs.bastion_subnet_id }}" \
            -var="aks_subnet_cidr=${{ needs.network.outputs.aks_subnet_address_prefixes[0] }}" \
            -var="tf_backend_resource_group=${{ needs.setup.outputs.tf_rg }}" \
            -var="tf_backend_storage_account=${{ needs.setup.outputs.tf_sa }}" \
            -var="tf_backend_container=${{ needs.setup.outputs.tf_container }}" \
            -var="tf_backend_sas_token=${{ needs.setup.outputs.sas_token }}" \
            -auto-approve -input=false

  # =====================================================
  # 7. DEPLOY APP/K8S
  # =====================================================
  deploy-app:
    runs-on: [self-hosted, bastion]
    needs: [aks, database, bastion]

    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version  # Verifica instala√ß√£o

      - name: Azure Login
        run: |
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"
          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"

      - name: Get AKS Credentials
        run: |
          az aks get-credentials \
            --resource-group "${{ needs.aks.outputs.resource_group_name }}" \
            --name "${{ needs.aks.outputs.cluster_name }}" \
            --overwrite-existing

      - name: Deploy FastAPI via Helm
        run: |
          helm upgrade --install fastapi \
            infraestructure/helm/fastapi \
            --namespace devops-app \
            --create-namespace \
            --wait  # Aguarda rollout completo

  # =========================
  # 8. VALIDATE & SAVE OUTPUTS
  # =========================
  validate:
    runs-on: ubuntu-latest
    needs: [network, acr, aks, database, bastion, deploy-app]
    if: always()

    steps:
      - name: Show Results
        run: |
          echo "üìä Deployment Results:"
          echo "Network: ${{ needs.network.result }}"
          echo "ACR: ${{ needs.acr.result }}"
          echo "AKS: ${{ needs.aks.result }}"
          echo "Database: ${{ needs.database.result }}"
          echo "Bastion: ${{ needs.bastion.result }}"
          echo "Deploy App: ${{ needs.deploy-app.result }}"

          SUCCESS_COUNT=0
          TOTAL_COUNT=6

          if [ "${{ needs.network.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.acr.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.aks.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.database.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.bastion.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi
          if [ "${{ needs.deploy-app.result }}" = "success" ]; then SUCCESS_COUNT=$((SUCCESS_COUNT + 1)); fi

          echo ""
          echo "üéØ Summary: $SUCCESS_COUNT/$TOTAL_COUNT modules succeeded"

          if [ $SUCCESS_COUNT -eq $TOTAL_COUNT ]; then
            echo "‚úÖ All infrastructure modules deployed successfully!"
          else
            echo "‚ö†Ô∏è  Some modules failed. Check the logs above."
          fi
