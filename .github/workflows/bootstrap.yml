name: Terraform Bootstrap (Backend)

on:
  workflow_dispatch:
    inputs:
      location:
        description: "Azure region"
        required: true
        default: "eastus"
        type: string
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  LOCATION: ${{ github.event.inputs.location }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  RESOURCE_GROUP_NAME: "rg-terraform-state-${{ github.event.inputs.environment }}"

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login (Service Principal)
        run: |
          echo "üîê Logging into Azure with Service Principal..."
          az login \
            --service-principal \
            --username "$ARM_CLIENT_ID" \
            --password "$ARM_CLIENT_SECRET" \
            --tenant "$ARM_TENANT_ID"

          az account set --subscription "$ARM_SUBSCRIPTION_ID"
          echo "‚úÖ Azure login successful"

          # Verificar login
          az account show --query "{name:name, id:id}" -o table

      - name: Create Resource Group
        run: |
          echo "üèóÔ∏è Creating Resource Group: $RESOURCE_GROUP_NAME"

          az group create \
            --name "$RESOURCE_GROUP_NAME" \
            --location "$LOCATION" \
            --tags "Environment=$ENVIRONMENT" "ManagedBy=GitHubActions" \
            --output none

          echo "‚úÖ Resource Group created"

      - name: Create Storage Account
        id: create-sa
        run: |
          # Gerar nome √∫nico para storage account
          TIMESTAMP=$(date +%Y%m%d%H%M)
          RANDOM_SUFFIX=$(openssl rand -hex 3)
          STORAGE_BASE="tfstate${ENVIRONMENT}${TIMESTAMP}${RANDOM_SUFFIX}"
          STORAGE_NAME=$(echo "$STORAGE_BASE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-24)

          echo "üíæ Creating Storage Account: $STORAGE_NAME"

          az storage account create \
            --name "$STORAGE_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --location "$LOCATION" \
            --sku Standard_LRS \
            --kind StorageV2 \
            --https-only true \
            --allow-blob-public-access false \
            --min-tls-version "TLS1_2" \
            --tags "Environment=$ENVIRONMENT" "ManagedBy=GitHubActions" \
            --output none

          echo "storage_account_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Storage Account created"

      - name: Create Container and Configure
        run: |
          SA_NAME="${{ steps.create-sa.outputs.storage_account_name }}"

          echo "üìÅ Creating container 'tfstate'..."
          az storage container create \
            --name "tfstate" \
            --account-name "$SA_NAME" \
            --auth-mode key \
            --public-access off \
            --output none

          echo "‚öôÔ∏è Configuring Storage Account..."
          # Habilitar versioning
          az storage account blob-service-properties update \
            --account-name "$SA_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --enable-versioning true \
            --output none

          echo "‚úÖ Container created and configured"

      - name: Output Backend Configuration
        run: |
          cat << EOF
          üéâ Terraform Backend Created Successfully!

          üìã Backend Configuration:
          ========================================
          resource_group_name  = "$RESOURCE_GROUP_NAME"
          storage_account_name = "${{ steps.create-sa.outputs.storage_account_name }}"
          container_name       = "tfstate"

          üí° Use these values in your Terraform backend config:

          terraform {
            backend "azurerm" {
              resource_group_name  = "$RESOURCE_GROUP_NAME"
              storage_account_name = "${{ steps.create-sa.outputs.storage_account_name }}"
              container_name       = "tfstate"
              key                  = "<module-name>.tfstate"
            }
          }
          EOF

    outputs:
      storage_account_name: ${{ steps.create-sa.outputs.storage_account_name }}
      resource_group_name: ${{ env.RESOURCE_GROUP_NAME }}
      container_name: "tfstate"
      environment: ${{ env.ENVIRONMENT }}
      location: ${{ env.LOCATION }}
