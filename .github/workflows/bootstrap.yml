name: Terraform Bootstrap (Backend)

on:
  workflow_dispatch:
    inputs:
      location:
        description: "Azure region"
        required: true
        default: "eastus"
        type: string
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  LOCATION: ${{ github.event.inputs.location }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  RESOURCE_GROUP_NAME: "rg-terraform-state-${{ github.event.inputs.environment }}"

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Validate Environment Input
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
          VALID_ENVS=("dev" "staging" "prod")

          if [[ ! " ${VALID_ENVS[@]} " =~ " ${ENVIRONMENT} " ]]; then
            echo "âŒ Invalid environment: ${ENVIRONMENT}. Must be one of: ${VALID_ENVS[*]}"
            exit 1
          fi
          echo "âœ… Environment validated: ${ENVIRONMENT}"

      - name: Generate Storage Account Name
        id: generate-name
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"

          # Para workflow_dispatch, usamos timestamp em vez de git sha
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          RANDOM_SUFFIX=$(openssl rand -hex 3)

          # PadrÃ£o: tfstate + env + timestamp + random
          STORAGE_BASE="tfstate${ENVIRONMENT}${TIMESTAMP}${RANDOM_SUFFIX}"

          # Limitar para 24 chars, somente lowercase alfanumÃ©rico
          STORAGE_NAME=$(echo "$STORAGE_BASE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-24)

          echo "ðŸ“¦ Generated Storage Account Name: $STORAGE_NAME"
          echo "storage_account_name=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "resource_group_name=rg-terraform-state-$ENVIRONMENT" >> $GITHUB_OUTPUT

      - name: Create Resource Group
        id: create-rg
        run: |
          LOCATION="${{ github.event.inputs.location }}"
          RG_NAME="rg-terraform-state-${{ github.event.inputs.environment }}"

          echo "ðŸ—ï¸ Creating Resource Group: $RG_NAME in $LOCATION"

          # Criar ou atualizar resource group (idempotente)
          az group create \
            --name "$RG_NAME" \
            --location "$LOCATION" \
            --tags "Environment=${{ github.event.inputs.environment }}" \
                    "ManagedBy=GitHubActions" \
                    "Purpose=TerraformState" \
                    "Created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --output none
            
          echo "âœ… Resource Group created/updated"
          echo "rg_created=true" >> $GITHUB_OUTPUT

      - name: Create Storage Account
        id: create-sa
        run: |
          RG_NAME="rg-terraform-state-${{ github.event.inputs.environment }}"
          SA_NAME="${{ steps.generate-name.outputs.storage_account_name }}"
          LOCATION="${{ github.event.inputs.location }}"

          echo "ðŸ’¾ Creating Storage Account: $SA_NAME"

          # Verificar se jÃ¡ existe
          EXISTING=$(az storage account list \
            --resource-group "$RG_NAME" \
            --query "[?name=='$SA_NAME'].name" \
            --output tsv)

          if [ -z "$EXISTING" ]; then
            az storage account create \
              --name "$SA_NAME" \
              --resource-group "$RG_NAME" \
              --location "$LOCATION" \
              --sku Standard_LRS \
              --kind StorageV2 \
              --https-only true \
              --allow-blob-public-access false \
              --min-tls-version "TLS1_2" \
              --tags "Environment=${{ github.event.inputs.environment }}" \
                      "ManagedBy=GitHubActions" \
                      "Purpose=TerraformState" \
              --output none
              
            echo "âœ… Storage Account created"
          else
            echo "ðŸ“Œ Storage Account already exists"
          fi

          echo "sa_created=true" >> $GITHUB_OUTPUT

      - name: Configure Storage Account
        run: |
          RG_NAME="rg-terraform-state-${{ github.event.inputs.environment }}"
          SA_NAME="${{ steps.generate-name.outputs.storage_account_name }}"

          echo "âš™ï¸ Configuring Storage Account..."

          # 1. Criar container para tfstate
          az storage container create \
            --name "tfstate" \
            --account-name "$SA_NAME" \
            --auth-mode login \
            --public-access off \
            --fail-on-exist false \
            --output none

          echo "âœ… Container 'tfstate' created/verified"

          # 2. Habilitar versioning
          az storage account blob-service-properties update \
            --account-name "$SA_NAME" \
            --resource-group "$RG_NAME" \
            --enable-versioning true \
            --output none

          echo "âœ… Blob versioning enabled"

          # 3. Configurar network rules (deny public access)
          az storage account update \
            --name "$SA_NAME" \
            --resource-group "$RG_NAME" \
            --default-action Deny \
            --bypass AzureServices \
            --output none

          echo "âœ… Network rules configured"

      - name: Generate Terraform Backend Configuration
        run: |
          ENV="${{ github.event.inputs.environment }}"
          SA_NAME="${{ steps.generate-name.outputs.storage_account_name }}"
          RG_NAME="rg-terraform-state-$ENV"

          # Criar arquivo de configuraÃ§Ã£o
          cat > backend-config.hcl << EOF
          # Terraform Backend Configuration for $ENV environment
          # Auto-generated by Bootstrap Pipeline

          storage_account_name = "$SA_NAME"
          container_name       = "tfstate"
          resource_group_name  = "$RG_NAME"

          # Module-specific state files
          # network.tfstate, aks.tfstate, database.tfstate, etc.
          EOF

          # Criar tambÃ©m um arquivo JSON para fÃ¡cil parsing
          cat > backend-config.json << EOF
          {
            "storage_account_name": "$SA_NAME",
            "container_name": "tfstate",
            "resource_group_name": "$RG_NAME",
            "environment": "$ENV",
            "location": "${{ github.event.inputs.location }}",
            "generated_at": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF

          echo "ðŸ” Backend configuration generated:"
          echo "========================================"
          cat backend-config.hcl
          echo ""
          echo "ðŸ“Š JSON version saved for automation"

      - name: Upload Backend Configuration
        uses: actions/upload-artifact@v4
        with:
          name: terraform-backend-${{ github.event.inputs.environment }}
          path: |
            backend-config.hcl
            backend-config.json
          retention-days: 30

      - name: Save Outputs to GitHub Environment Variables
        if: success()
        run: |
          # Criar arquivo para setar variÃ¡veis de ambiente em workflows subsequentes
          ENV_FILE="$GITHUB_ENV"

          echo "TF_STATE_SA=${{ steps.generate-name.outputs.storage_account_name }}" >> $ENV_FILE
          echo "TF_STATE_RG=rg-terraform-state-${{ github.event.inputs.environment }}" >> $ENV_FILE
          echo "TF_STATE_CONTAINER=tfstate" >> $ENV_FILE
          echo "TF_ENVIRONMENT=${{ github.event.inputs.environment }}" >> $ENV_FILE
          echo "TF_LOCATION=${{ github.event.inputs.location }}" >> $ENV_FILE

          echo "âœ… Environment variables set for subsequent steps"

    outputs:
      storage_account_name: ${{ steps.generate-name.outputs.storage_account_name }}
      resource_group_name: rg-terraform-state-${{ github.event.inputs.environment }}
      environment: ${{ github.event.inputs.environment }}
      location: ${{ github.event.inputs.location }}
