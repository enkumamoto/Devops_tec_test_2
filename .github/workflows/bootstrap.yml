name: Terraform Bootstrap (Backend)

on:
  workflow_dispatch:
    inputs:
      location:
        description: "Azure region"
        required: true
        default: "eastus"
        type: string
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: string
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  LOCATION: ${{ github.event.inputs.location || 'eastus' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}
  RESOURCE_GROUP_NAME: "rg-terraform-state-${{ env.ENVIRONMENT }}"

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Validate Environment Input
        run: |
          VALID_ENVS=("dev" "staging" "prod")
          if [[ ! " ${VALID_ENVS[@]} " =~ " $ENVIRONMENT " ]]; then
            echo "‚ùå Invalid environment: $ENVIRONMENT. Must be one of: ${VALID_ENVS[*]}"
            exit 1
          fi

      - name: Create Terraform Backend Resources
        id: create-backend
        run: |
          # 1. Resource Group (idempotent)
          az group create \
            --name "$RESOURCE_GROUP_NAME" \
            --location "$LOCATION" \
            --tags "Environment=$ENVIRONMENT" "ManagedBy=GitHubActions" "CreatedBy=Bootstrap" \
            --output none

          # 2. Generate deterministic storage account name (Azure naming rules)
          #    - Max 24 chars, lowercase, no hyphens
          #    - Pattern: tfstate<env><short-sha><suffix>
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TIMESTAMP=$(date +%m%d)
          STORAGE_BASE="tfstate${ENVIRONMENT}${SHORT_SHA}${TIMESTAMP}"
          STORAGE_NAME=$(echo "$STORAGE_BASE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-24)

          echo "üì¶ Storage Account Name: $STORAGE_NAME"

          # 3. Create Storage Account (if not exists)
          EXISTING_SA=$(az storage account list \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --query "[?name=='$STORAGE_NAME'].name" \
            --output tsv)

          if [ -z "$EXISTING_SA" ]; then
            az storage account create \
              --name "$STORAGE_NAME" \
              --resource-group "$RESOURCE_GROUP_NAME" \
              --location "$LOCATION" \
              --sku Standard_LRS \
              --kind StorageV2 \
              --https-only true \
              --allow-blob-public-access false \
              --min-tls-version TLS1_2 \
              --tags "Environment=$ENVIRONMENT" "ManagedBy=GitHubActions" \
              --output none
            echo "‚úÖ Storage Account created: $STORAGE_NAME"
          else
            echo "üìå Storage Account already exists: $STORAGE_NAME"
          fi

          # 4. Create Container (idempotent)
          az storage container create \
            --name "tfstate" \
            --account-name "$STORAGE_NAME" \
            --auth-mode login \
            --fail-on-exist false \
            --output none

          # 5. Enable blob versioning (idempotent)
          az storage account blob-service-properties update \
            --account-name "$STORAGE_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --enable-versioning true \
            --output none

          # 6. Set network rules (idempotent)
          az storage account network-rule update \
            --account-name "$STORAGE_NAME" \
            --resource-group "$RESOURCE_GROUP_NAME" \
            --default-action Deny \
            --bypass AzureServices \
            --output none

          # 7. Outputs for next workflows
          echo "TF_STORAGE_ACCOUNT=$STORAGE_NAME" >> $GITHUB_OUTPUT
          echo "TF_RESOURCE_GROUP=$RESOURCE_GROUP_NAME" >> $GITHUB_OUTPUT
          echo "TF_CONTAINER_NAME=tfstate" >> $GITHUB_OUTPUT
          echo "TF_LOCATION=$LOCATION" >> $GITHUB_OUTPUT
          echo "TF_ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_OUTPUT

      - name: Generate Backend Config File
        run: |
          cat > backend-config.txt << EOF
          # Terraform Backend Configuration
          # Generated by Bootstrap Pipeline
          storage_account_name = "${{ steps.create-backend.outputs.TF_STORAGE_ACCOUNT }}"
          container_name       = "tfstate"
          resource_group_name  = "${{ steps.create-backend.outputs.TF_RESOURCE_GROUP }}"
          # Note: 'key' is defined per module (network.tfstate, aks.tfstate, etc.)
          EOF

          echo "üîê Backend config generated:"
          cat backend-config.txt

      - name: Upload Backend Config as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-backend-${{ env.ENVIRONMENT }}
          path: backend-config.txt
          retention-days: 7

    outputs:
      storage_account_name: ${{ steps.create-backend.outputs.TF_STORAGE_ACCOUNT }}
      resource_group_name: ${{ steps.create-backend.outputs.TF_RESOURCE_GROUP }}
      container_name: ${{ steps.create-backend.outputs.TF_CONTAINER_NAME }}
      location: ${{ steps.create-backend.outputs.TF_LOCATION }}
      environment: ${{ steps.create-backend.outputs.TF_ENVIRONMENT }}