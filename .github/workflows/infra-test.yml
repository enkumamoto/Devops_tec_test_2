name: Terraform Infrastructure TEST

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      module_number:
        description: "Module number to test"
        required: true
        default: "01"
        type: choice
        options:
          - "01"
          - "02"
          - "03"
          - "04"
          - "05"

jobs:
  terraform-test:
    runs-on: ubuntu-latest
    environment: test

    env:
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
      ARM_USE_MSI: "false"
      ARM_USE_CLI: "false"
      TF_IN_AUTOMATION: "true"
      TF_INPUT: "false"

    steps:
      - name: Configure Azure Authentication
        run: |
          echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=$ARM_CLIENT_ID" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$ARM_CLIENT_SECRET" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$ARM_TENANT_ID" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Find Module
        id: find-module
        run: |
          FOUND=$(find infraestructure -maxdepth 1 -type d -name "${{ github.event.inputs.module_number }}-*" | head -1)

          if [ -z "$FOUND" ]; then
            echo "Module not found"
            exit 1
          fi

          echo "MODULE_PATH=$FOUND" >> $GITHUB_OUTPUT
          echo "MODULE_NAME=$(basename $FOUND)" >> $GITHUB_OUTPUT
          echo "MODULE_NUMBER=${{ github.event.inputs.module_number }}" >> $GITHUB_OUTPUT

      - name: Disable Backend for Testing
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"

          if [ -f "backend.tf" ]; then
            cp backend.tf backend.tf.backup
            rm backend.tf
          fi

      - name: Initialize Terraform
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"
          terraform init -backend=false

      - name: Create Module-Specific Test Variables
        id: create-vars
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"
          MODULE_NUM="${{ steps.find-module.outputs.MODULE_NUMBER }}"

          if [ "$MODULE_NUM" = "01" ]; then
            cat > test.auto.tfvars << 'EOF'
              resource_group_name = "rg-network-dev"
          vnet_name = "vnet-dev"
          vnet_address_space = ["10.0.0.0/16"]
          aks_subnet_address_prefixes = ["10.0.1.0/24"]
          database_subnet_address_prefixes = ["10.0.2.0/24"]
          bastion_subnet_address_prefixes = ["10.0.3.0/24"]
          location = "eastus"
          environment = "dev"
          azure_subscription_id = "$ARM_SUBSCRIPTION_ID"
          azure_client_id = "$ARM_CLIENT_ID"
          azure_client_secret = "$ARM_CLIENT_SECRET"
          azure_tenant_id = "$ARM_TENANT_ID"
          tags = {
            Environment = "dev"
            Project = "devops-test"
          }
          EOF
                echo "Created variables for 01-network"
                
              elif [ "$MODULE_NUM" = "02" ]; then
                cat > test.auto.tfvars << 'EOF'
          resource_group_name = "rg-acr-dev"
          location = "eastus"
          acr_sku = "Standard"
          admin_enabled = false
          project = "devops"
          environment = "dev"
          azure_subscription_id = "$ARM_SUBSCRIPTION_ID"
          azure_client_id = "$ARM_CLIENT_ID"
          azure_client_secret = "$ARM_CLIENT_SECRET"
          azure_tenant_id = "$ARM_TENANT_ID"
          tags = {
            Environment = "dev"
            Project = "devops-test"
          }
          EOF
                echo "Created variables for 02-acr"
                
              elif [ "$MODULE_NUM" = "03" ]; then
                cat > test.auto.tfvars << 'EOF'
          resource_group_name = "rg-aks-dev"
          location = "eastus"
          environment = "dev"
          azure_subscription_id = "$ARM_SUBSCRIPTION_ID"
          azure_client_id = "$ARM_CLIENT_ID"
          azure_client_secret = "$ARM_CLIENT_SECRET"
          azure_tenant_id = "$ARM_TENANT_ID"
          tags = {
            Environment = "dev"
            Project = "devops-test"
          }
          EOF
                echo "Created variables for 03-aks"
                
              elif [ "$MODULE_NUM" = "04" ]; then
                cat > test.auto.tfvars << 'EOF'
          resource_group_name = "rg-bastion-dev"
          location = "eastus"
          environment = "dev"
          azure_subscription_id = "$ARM_SUBSCRIPTION_ID"
          azure_client_id = "$ARM_CLIENT_ID"
          azure_client_secret = "$ARM_CLIENT_SECRET"
          azure_tenant_id = "$ARM_TENANT_ID"
          tags = {
            Environment = "dev"
            Project = "devops-test"
          }
          EOF
                echo "Created variables for 04-bastion"
                
              elif [ "$MODULE_NUM" = "05" ]; then
                cat > test.auto.tfvars << 'EOF'
          resource_group_name = "rg-database-dev"
          location = "eastus"
          environment = "dev"
          azure_subscription_id = "$ARM_SUBSCRIPTION_ID"
          azure_client_id = "$ARM_CLIENT_ID"
          azure_client_secret = "$ARM_CLIENT_SECRET"
          azure_tenant_id = "$ARM_TENANT_ID"
          tags = {
            Environment = "dev"
            Project = "devops-test"
          }
          EOF
            echo "Created variables for 05-database"
          fi

          echo "Created test.auto.tfvars for module $MODULE_NUM"

      - name: Show Generated Variables
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"
          echo "=== Generated test.auto.tfvars ==="
          cat test.auto.tfvars

      - name: Validate Configuration
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"
          terraform validate

      - name: Run Terraform Plan
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"
          terraform plan -input=false -compact-warnings

      - name: Restore Backend
        if: always()
        run: |
          cd "${{ steps.find-module.outputs.MODULE_PATH }}"

          if [ -f "backend.tf.backup" ]; then
            mv backend.tf.backup backend.tf
          fi

          rm -f test.auto.tfvars
          rm -rf .terraform
