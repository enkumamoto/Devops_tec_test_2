name: Terraform Infrastructure TEST (No Backend)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      module_number:
        description: "Module number to test"
        required: true
        default: "01"
        type: choice
        options:
          - "00"
          - "01"
          - "02"
          - "03"
          - "04"
          - "05"

jobs:
  terraform-test:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Validate Module Exists
        id: validate-module
        run: |
          # ... (mesmo código que já tem)

      - name: Create Temporary Terraform Files (NO BACKEND)
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          BACKUP_DIR="${MODULE_PATH}_backup_${GITHUB_RUN_ID}"

          # 1. Fazer backup dos arquivos originais
          cp -r "${MODULE_PATH}" "${BACKUP_DIR}"

          # 2. Remover/renomear backend.tf se existir
          if [ -f "${MODULE_PATH}/backend.tf" ]; then
            mv "${MODULE_PATH}/backend.tf" "${MODULE_PATH}/backend.tf.disabled"
            echo "⚠️ Temporarily disabled backend.tf for testing"
          fi

          # 3. Se houver provider.tf ou main.tf com backend, comentar
          for file in "${MODULE_PATH}"/*.tf; do
            if [ -f "$file" ]; then
              # Remover blocos de backend
              sed -i '/^terraform {/,/^}/ {/backend "/,/}/d}' "$file" 2>/dev/null || true
            fi
          done

          echo "BACKUP_DIR=${BACKUP_DIR}" >> $GITHUB_ENV

      - name: Run Terraform Commands (No Backend)
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"

          # Inicializar SEM backend
          terraform init -backend=false -input=false

          # Validar
          terraform validate

          # Fmt check
          terraform fmt -check -recursive

          # Plan com variáveis de teste
          terraform plan \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="location=eastus" \
            -var="project_name=devops-test" \
            -input=false \
            -lock=false

      - name: Restore Original Files
        if: always()
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          BACKUP_DIR="${{ env.BACKUP_DIR }}"

          if [ -d "$BACKUP_DIR" ]; then
            # Restaurar arquivos originais
            find "$BACKUP_DIR" -name "*.tf" -exec cp {} "$MODULE_PATH/" \;
            
            # Remover backup
            rm -rf "$BACKUP_DIR"
            echo "✅ Original files restored"
          fi
