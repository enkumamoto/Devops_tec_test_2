name: Terraform Infrastructure TEST (No Backend)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      module_number:
        description: "Module number to test"
        required: true
        default: "01"
        type: choice
        options:
          - "00"
          - "01"
          - "02"
          - "03"
          - "04"
          - "05"

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  MODULE_NUMBER: ${{ github.event.inputs.module_number }}

jobs:
  terraform-test:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Validate Module Exists
        id: validate-module
        run: |
          MODULE_DIR="infraestructure/${{ env.MODULE_NUMBER }}-*"
          echo "ğŸ” Looking for module: $MODULE_DIR"

          # Listar mÃ³dulos disponÃ­veis
          echo "ğŸ“¦ Available modules:"
          find infraestructure -maxdepth 1 -type d -name "[0-9]*" | sort

          # Encontrar mÃ³dulo especÃ­fico
          FOUND_DIR=$(find infraestructure -maxdepth 1 -type d -name "${{ env.MODULE_NUMBER }}-*" | head -1)

          if [ -n "$FOUND_DIR" ] && [ -d "$FOUND_DIR" ]; then
            MODULE_NAME=$(basename "$FOUND_DIR")
            echo "âœ… Module found: $MODULE_NAME"
            echo "MODULE_NAME=$MODULE_NAME" >> $GITHUB_OUTPUT
            echo "MODULE_PATH=$FOUND_DIR" >> $GITHUB_OUTPUT
            
            # Mostrar estrutura
            echo "ğŸ“ Module structure:"
            find "$FOUND_DIR" -name "*.tf" -o -name "*.tfvars" | sort
          else
            echo "âŒ Module ${{ env.MODULE_NUMBER }}-* not found"
            exit 1
          fi

      - name: Azure Login (Optional - for backend tests)
        run: |
          echo "ğŸ”‘ Logging into Azure..."
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}" || echo "âš ï¸ Azure login optional for this test"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}" || true

      - name: Create Temporary Terraform Files (NO BACKEND)
        id: disable-backend
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"

          echo "ğŸ“ Module path: ${MODULE_PATH}"

          if [ ! -d "${MODULE_PATH}" ]; then
            echo "âŒ ERROR: Module directory does not exist: ${MODULE_PATH}"
            exit 1
          fi

          BACKUP_DIR="${MODULE_PATH}_backup_${GITHUB_RUN_ID}"

          # 1. Fazer backup dos arquivos originais
          echo "ğŸ’¾ Creating backup in: ${BACKUP_DIR}"
          mkdir -p "${BACKUP_DIR}"
          cp -r "${MODULE_PATH}/"* "${BACKUP_DIR}/" 2>/dev/null || true

          # 2. Remover/renomear backend.tf se existir
          if [ -f "${MODULE_PATH}/backend.tf" ]; then
            mv "${MODULE_PATH}/backend.tf" "${MODULE_PATH}/backend.tf.disabled"
            echo "âš ï¸ Temporarily disabled backend.tf for testing"
          fi

          # 3. Remover blocos de backend de outros arquivos .tf
          for file in "${MODULE_PATH}"/*.tf; do
            if [ -f "$file" ]; then
              # Usar uma abordagem mais segura com arquivo temporÃ¡rio
              if grep -q "backend \"" "$file"; then
                echo "ğŸ”§ Removing backend block from: $(basename "$file")"
                TEMP_FILE="${file}.temp"
                awk '/^terraform {/,/^}/ {if (/backend "/) skip=1; if (skip && /}/) skip=0; if (!skip) print} !/^terraform {/,/^}/ {print}' "$file" > "$TEMP_FILE"
                mv "$TEMP_FILE" "$file"
              fi
            fi
          done

          echo "BACKUP_DIR=${BACKUP_DIR}" >> $GITHUB_ENV
      - name: Configure Provider Authentication
        run: |
          # Exportar variÃ¡veis ARM_* para o Terraform
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=${{ secrets.ARM_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ secrets.ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.ARM_TENANT_ID }}" >> $GITHUB_ENV

      - name: Replace Backend Placeholders
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"

          # Usar valores padrÃ£o ou do job setup
          TF_RG="${TF_BACKEND_RG:-rg-terraform-state-dev}"
          TF_SA="${TF_BACKEND_SA:-tfstatedevdevops}"
          TF_CONTAINER="${TF_BACKEND_CONTAINER:-tfstate}"

          sed -i "s|__TF_BACKEND_RESOURCE_GROUP__|${TF_RG}|g" backend.tf
          sed -i "s|__TF_BACKEND_STORAGE_ACCOUNT__|${TF_SA}|g" backend.tf
          sed -i "s|__TF_BACKEND_CONTAINER__|${TF_CONTAINER}|g" backend.tf

      - name: Run Terraform Commands (No Backend)
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"

          echo "ğŸ§± Initializing Terraform (no backend)..."
          terraform init -backend=false -input=false

          echo "ğŸ” Validating Terraform syntax..."
          terraform validate

          echo "ğŸ“ Checking Terraform formatting..."
          terraform fmt -check -recursive || echo "âš ï¸ Formatting issues found"

          # Criar arquivo de variÃ¡veis temporÃ¡rio para teste
          cat > test.tfvars << EOF
          environment = "${{ env.ENVIRONMENT }}"
          location = "eastus"
          project_name = "devops-test"
          EOF

          echo "ğŸ“‹ Running terraform plan..."
          terraform plan \
            -var-file="test.tfvars" \
            -out=tfplan \
            -input=false \
            -detailed-exitcode

          PLAN_EXIT_CODE=$?

          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "âœ… No changes needed"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "ğŸ“ Changes detected"
            echo ""
            echo "ğŸ“Š Change Summary:"
            terraform show -json tfplan | jq -r '
              .resource_changes[] | 
              "\(.type) \(.name): \(.change.actions | join(", "))"
            ' | head -20
          else
            echo "âŒ Terraform plan failed with exit code: $PLAN_EXIT_CODE"
            exit 1
          fi

      - name: Restore Original Files
        if: always()
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          BACKUP_DIR="${{ env.BACKUP_DIR }}"

          echo "ğŸ“ Restoring original files..."

          if [ -d "$BACKUP_DIR" ]; then
            # 1. Restaurar backend.tf se estava desabilitado
            if [ -f "${MODULE_PATH}/backend.tf.disabled" ]; then
              mv "${MODULE_PATH}/backend.tf.disabled" "${MODULE_PATH}/backend.tf"
              echo "âœ… Restored backend.tf"
            fi
            
            # 2. Restaurar outros arquivos .tf do backup
            for file in "$BACKUP_DIR"/*.tf; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "${MODULE_PATH}/${filename}"
                echo "âœ… Restored: $filename"
              fi
            done
            
            # 3. Remover backup
            rm -rf "$BACKUP_DIR"
            echo "âœ… Backup directory removed"
          fi

      - name: Upload Plan as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ steps.validate-module.outputs.MODULE_NAME }}-${{ github.run_id }}
          path: ${{ steps.validate-module.outputs.MODULE_PATH }}/tfplan
          retention-days: 7
