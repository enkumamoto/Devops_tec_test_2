name: Terraform Infrastructure TEST (Plan Only)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      module_number:
        description: "Module number to test (ex: 01, 02, etc.)"
        required: true
        default: "01"
        type: choice
        options:
          - "00"
          - "01"
          - "02"
          - "03"
          - "04"
          - "05"

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  MODULE_NUMBER: ${{ github.event.inputs.module_number }}

jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Validate Module Exists
        id: validate-module
        run: |
          MODULE_DIR="infraestructure/${{ env.MODULE_NUMBER }}-*"
          echo "üîç Looking for module: $MODULE_DIR"

          # Listar m√≥dulos dispon√≠veis
          echo "üì¶ Available modules:"
          find infraestructure -maxdepth 1 -type d -name "[0-9]*" | sort

          # Encontrar m√≥dulo espec√≠fico
          FOUND_DIR=$(find infraestructure -maxdepth 1 -type d -name "${{ env.MODULE_NUMBER }}-*" | head -1)

          if [ -n "$FOUND_DIR" ] && [ -d "$FOUND_DIR" ]; then
            MODULE_NAME=$(basename "$FOUND_DIR")
            echo "‚úÖ Module found: $MODULE_NAME"
            echo "MODULE_NAME=$MODULE_NAME" >> $GITHUB_OUTPUT
            echo "MODULE_PATH=$FOUND_DIR" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Module ${{ env.MODULE_NUMBER }}-* not found"
            exit 1
          fi

      - name: Azure Login
        run: |
          echo "üîë Logging into Azure..."
          az login \
            --service-principal \
            --username "${{ secrets.ARM_CLIENT_ID }}" \
            --password "${{ secrets.ARM_CLIENT_SECRET }}" \
            --tenant "${{ secrets.ARM_TENANT_ID }}"

          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
          echo "‚úÖ Azure login successful"

      - name: Initialize Terraform Module
        run: |
          echo "üß± Initializing module: ${{ steps.validate-module.outputs.MODULE_NAME }}"
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"

          # Mostrar estrutura do m√≥dulo
          echo "üìÅ Module structure:"
          find . -name "*.tf" -o -name "*.tfvars" | sort

          # Usar backend local para teste
          terraform init -backend=false -input=false
          echo "‚úÖ Terraform initialized"

      - name: Terraform Validate
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"
          echo "üîç Validating Terraform syntax..."
          terraform validate
          echo "‚úÖ Terraform validation passed"

      - name: Terraform Format Check
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"
          echo "üìù Checking Terraform formatting..."
          terraform fmt -check -recursive
          echo "‚úÖ Terraform formatting is correct"

      - name: Terraform Plan (What-if)
        id: plan
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"

          # Criar arquivo de vari√°veis tempor√°rio para teste
          cat > test.tfvars << EOF
          environment = "${{ env.ENVIRONMENT }}"
          location = "eastus"
          project_name = "devops-test"
          EOF

          echo "üìã Running terraform plan..."
          terraform plan \
            -var-file="test.tfvars" \
            -out=tfplan \
            -input=false \
            -detailed-exitcode

          PLAN_EXIT_CODE=$?

          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No changes needed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "üìù Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Mostrar resumo das mudan√ßas
            echo ""
            echo "üìä Change Summary:"
            terraform show -json tfplan | jq -r '
              .resource_changes[] | 
              "\(.type) \(.name): \(.change.actions | join(", "))"
            ' | head -20
          else
            echo "‚ùå Terraform plan failed with exit code: $PLAN_EXIT_CODE"
            exit 1
          fi

      - name: Show Plan Details
        if: steps.plan.outputs.has_changes == 'true'
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"
          echo "üîç Detailed plan output:"
          terraform show tfplan | head -100

      - name: Upload Plan as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ steps.validate-module.outputs.MODULE_NAME }}-${{ github.run_id }}
          path: ${{ steps.validate-module.outputs.MODULE_PATH }}/tfplan
          retention-days: 7
