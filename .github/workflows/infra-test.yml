name: Terraform Infrastructure TEST (No Backend)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      module_number:
        description: "Module number to test"
        required: true
        default: "01"
        type: choice
        options:
          - "00"
          - "01"
          - "02"
          - "03"
          - "04"
          - "05"

env:
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  MODULE_NUMBER: ${{ github.event.inputs.module_number }}

jobs:
  terraform-test:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Validate Module Exists
        id: validate-module
        run: |
          MODULE_DIR="infraestructure/${{ env.MODULE_NUMBER }}-*"
          echo "ğŸ” Looking for module: $MODULE_DIR"

          # Listar mÃ³dulos disponÃ­veis
          echo "ğŸ“¦ Available modules:"
          find infraestructure -maxdepth 1 -type d -name "[0-9]*" | sort

          # Encontrar mÃ³dulo especÃ­fico
          FOUND_DIR=$(find infraestructure -maxdepth 1 -type d -name "${{ env.MODULE_NUMBER }}-*" | head -1)

          if [ -n "$FOUND_DIR" ] && [ -d "$FOUND_DIR" ]; then
            MODULE_NAME=$(basename "$FOUND_DIR")
            echo "âœ… Module found: $MODULE_NAME"
            echo "MODULE_NAME=$MODULE_NAME" >> $GITHUB_OUTPUT
            echo "MODULE_PATH=$FOUND_DIR" >> $GITHUB_OUTPUT
            
            # Mostrar estrutura
            echo "ğŸ“ Module structure:"
            find "$FOUND_DIR" -name "*.tf" -o -name "*.tfvars" | sort
          else
            echo "âŒ Module ${{ env.MODULE_NUMBER }}-* not found"
            exit 1
          fi

      - name: Configure Provider Authentication
        id: setup-auth
        run: |
          # Configurar autenticaÃ§Ã£o Azure via Service Principal
          echo "ğŸ” Setting up Azure authentication..."
          
          # VariÃ¡veis para o provider Terraform
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.ARM_SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=${{ secrets.ARM_CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=${{ secrets.ARM_CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.ARM_TENANT_ID }}" >> $GITHUB_ENV
          
          # Log para debug (sem expor segredos completos)
          echo "âœ… Authentication configured:"
          echo "   Subscription: ${ARM_SUBSCRIPTION_ID:0:8}..."
          echo "   Client ID: ${ARM_CLIENT_ID:0:8}..."
          echo "   Tenant ID: ${ARM_TENANT_ID:0:8}..."

      - name: Create Temporary Terraform Files (NO BACKEND)
        id: disable-backend
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          
          echo "ğŸ“ Module path: ${MODULE_PATH}"
          
          if [ ! -d "${MODULE_PATH}" ]; then
            echo "âŒ ERROR: Module directory does not exist: ${MODULE_PATH}"
            exit 1
          fi
          
          BACKUP_DIR="${MODULE_PATH}_backup_${GITHUB_RUN_ID}"
          
          # 1. Fazer backup dos arquivos originais
          echo "ğŸ’¾ Creating backup in: ${BACKUP_DIR}"
          mkdir -p "${BACKUP_DIR}"
          cp -r "${MODULE_PATH}/"* "${BACKUP_DIR}/" 2>/dev/null || true
          
          # 2. Remover/renomear backend.tf se existir
          if [ -f "${MODULE_PATH}/backend.tf" ]; then
            mv "${MODULE_PATH}/backend.tf" "${MODULE_PATH}/backend.tf.disabled"
            echo "âš ï¸ Temporarily disabled backend.tf for testing"
          fi
          
          # 3. Remover blocos de backend de outros arquivos .tf
          for file in "${MODULE_PATH}"/*.tf; do
            if [ -f "$file" ]; then
              # Verificar se tem backend block
              if grep -q "backend \"" "$file"; then
                echo "ğŸ”§ Removing backend block from: $(basename "$file")"
                # Usar awk para remover bloco backend de forma segura
                awk '
                  /^terraform {/ { in_terraform=1 }
                  in_terraform && /backend "/ { in_backend=1 }
                  in_backend && /}/ { in_backend=0; next }
                  !in_backend { print }
                  /^}/ { in_terraform=0 }
                ' "$file" > "${file}.temp" && mv "${file}.temp" "$file"
              fi
            fi
          done
          
          echo "BACKUP_DIR=${BACKUP_DIR}" >> $GITHUB_ENV

      - name: Replace Backend Placeholders (for modules with backend.tf)
        if: env.MODULE_NUMBER != '00'
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          
          # Verificar se hÃ¡ backend.tf.disabled (que foi renomeado)
          if [ -f "${MODULE_PATH}/backend.tf.disabled" ]; then
            echo "ğŸ”§ Configurando backend placeholders..."
            
            # Usar valores consistentes com o bootstrap
            # Baseado na sua resposta: Storage Account = "rg-terraform-state-dev"
            # Mas isso parece ser o Resource Group. Precisamos do nome real do Storage Account
            # Vou usar um padrÃ£o baseado no environment
            TF_RG="rg-terraform-state-${{ env.ENVIRONMENT }}"
            TF_SA="tfstate${{ env.ENVIRONMENT }}devops"
            TF_CONTAINER="tfstate"
            
            echo "   Resource Group: ${TF_RG}"
            echo "   Storage Account: ${TF_SA}"
            echo "   Container: ${TF_CONTAINER}"
            
            # Aplicar substituiÃ§Ãµes no arquivo desabilitado
            sed -i \
              -e "s|__TF_BACKEND_RESOURCE_GROUP__|${TF_RG}|g" \
              -e "s|__TF_BACKEND_STORAGE_ACCOUNT__|${TF_SA}|g" \
              -e "s|__TF_BACKEND_CONTAINER__|${TF_CONTAINER}|g" \
              "${MODULE_PATH}/backend.tf.disabled"
              
            echo "âœ… Backend placeholders substituÃ­dos"
          else
            echo "â„¹ï¸ No backend.tf found in this module"
          fi

      - name: Run Terraform Commands (No Backend)
        env:
          # Garantir que as variÃ¡veis do provider estÃ£o disponÃ­veis
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          
          # ConfiguraÃ§Ãµes do Terraform
          TF_IN_AUTOMATION: "true"
          TF_INPUT: "false"
          TF_CLI_ARGS: "-no-color"
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"
          
          echo "ğŸ” Provider authentication status:"
          echo "   ARM_SUBSCRIPTION_ID: ${ARM_SUBSCRIPTION_ID:0:12}..."
          echo "   ARM_CLIENT_ID: ${ARM_CLIENT_ID:0:12}..."
          echo "   ARM_TENANT_ID: ${ARM_TENANT_ID:0:12}..."
          echo "   ARM_CLIENT_SECRET: [PROTECTED]"
          
          # Para mÃ³dulo 00-bootstrap, usar backend local
          if [ "${{ env.MODULE_NUMBER }}" = "00" ]; then
            echo "ğŸ§± Initializing Terraform (local backend for bootstrap)..."
            terraform init -input=false
          else
            echo "ğŸ§± Initializing Terraform (no backend)..."
            terraform init -backend=false -input=false
          fi
          
          echo "ğŸ” Validating Terraform syntax..."
          terraform validate
          
          echo "ğŸ“ Checking Terraform formatting..."
          terraform fmt -check -recursive || echo "âš ï¸ Formatting issues found (non-critical for test)"
          
          # Detectar variÃ¡veis necessÃ¡rias
          echo "ğŸ“‹ Detecting required variables..."
          VARIABLE_LIST=$(find . -name "variables.tf" -exec grep -h 'variable "' {} \; | sed 's/variable "\([^"]*\)".*/\1/' | sort | uniq)
          
          if [ -n "$VARIABLE_LIST" ]; then
            echo "ğŸ“„ Variables declared in module:"
            echo "$VARIABLE_LIST"
            
            # Criar test.tfvars com valores apropriados
            echo "ğŸ“ Creating test.tfvars..."
            cat > test.tfvars << 'EOF'
# ===========================================
# Test variables for module: ${{ steps.validate-module.outputs.MODULE_NAME }}
# Environment: ${{ env.ENVIRONMENT }}
# Generated: $(date)
# ===========================================

EOF
            
            # Adicionar variÃ¡veis baseadas no tipo e nome
            echo "$VARIABLE_LIST" | while read var_name; do
              case $var_name in
                # Provider authentication (deixar vazio - vem do ambiente)
                subscription_id|client_id|client_secret|tenant_id)
                  echo "${var_name} = \"\"" >> test.tfvars
                  ;;
                
                # Resource naming
                resource_group_name)
                  echo "resource_group_name = \"rg-network-${{ env.ENVIRONMENT }}\"" >> test.tfvars
                  ;;
                vnet_name)
                  echo "vnet_name = \"vnet-${{ env.ENVIRONMENT }}\"" >> test.tfvars
                  ;;
                
                # Network addressing
                vnet_address_space)
                  echo "vnet_address_space = [\"10.0.0.0/16\"]" >> test.tfvars
                  ;;
                aks_subnet_address_prefixes)
                  echo "aks_subnet_address_prefixes = [\"10.0.1.0/24\"]" >> test.tfvars
                  ;;
                database_subnet_address_prefixes)
                  echo "database_subnet_address_prefixes = [\"10.0.2.0/24\"]" >> test.tfvars
                  ;;
                bastion_subnet_address_prefixes)
                  echo "bastion_subnet_address_prefixes = [\"10.0.3.0/24\"]" >> test.tfvars
                  ;;
                
                # Common variables
                location)
                  echo "location = \"eastus\"" >> test.tfvars
                  ;;
                environment)
                  echo "environment = \"${{ env.ENVIRONMENT }}\"" >> test.tfvars
                  ;;
                project_name)
                  echo "project_name = \"devops-technical-test\"" >> test.tfvars
                  ;;
                
                # Tags
                tags)
                  echo "tags = {" >> test.tfvars
                  echo "  Environment = \"${{ env.ENVIRONMENT }}\"" >> test.tfvars
                  echo "  Project     = \"devops-technical-test\"" >> test.tfvars
                  echo "  ManagedBy   = \"Terraform\"" >> test.tfvars
                  echo "  Team        = \"DevOps\"" >> test.tfvars
                  echo "}" >> test.tfvars
                  ;;
                
                # Default para outras variÃ¡veis
                *)
                  # Tentar inferir tipo
                  if echo "$var_name" | grep -q -E "(count|number|size|port)"; then
                    echo "${var_name} = 1" >> test.tfvars
                  elif echo "$var_name" | grep -q -E "(enable|enabled|disable|disabled|force)"; then
                    echo "${var_name} = false" >> test.tfvars
                  else
                    echo "${var_name} = \"test-value\"" >> test.tfvars
                  fi
                  ;;
              esac
            done
            
            echo "ğŸ“„ Generated test.tfvars content:"
            cat test.tfvars
            echo ""
          else
            echo "âš ï¸ No variables.tf found or no variables declared"
            # Criar um test.tfvars mÃ­nimo
            cat > test.tfvars << EOF
environment = "${{ env.ENVIRONMENT }}"
location = "eastus"
EOF
          fi
          
          echo "ğŸ“‹ Running terraform plan..."
          terraform plan \
            -var-file="test.tfvars" \
            -compact-warnings \
            -input=false \
            -detailed-exitcode
          
          PLAN_EXIT_CODE=$?
          
          if [ $PLAN_EXIT_CODE -eq 0 ]; then
            echo "âœ… No changes needed"
          elif [ $PLAN_EXIT_CODE -eq 2 ]; then
            echo "ğŸ“ Changes detected"
            echo ""
            echo "ğŸ“Š Change Summary:"
            terraform show -json tfplan 2>/dev/null | jq -r '
              .resource_changes[] | 
              "\(.type) \(.name): \(.change.actions | join(", "))"
            ' | head -20 || echo "Could not generate change summary"
          else
            echo "âŒ Terraform plan failed with exit code: $PLAN_EXIT_CODE"
            exit 1
          fi

      - name: Restore Original Files
        if: always()
        run: |
          MODULE_PATH="${{ steps.validate-module.outputs.MODULE_PATH }}"
          BACKUP_DIR="${{ env.BACKUP_DIR }}"
          
          echo "ğŸ“ Restoring original files..."
          
          if [ -d "$BACKUP_DIR" ]; then
            # 1. Restaurar backend.tf se estava desabilitado
            if [ -f "${MODULE_PATH}/backend.tf.disabled" ]; then
              mv "${MODULE_PATH}/backend.tf.disabled" "${MODULE_PATH}/backend.tf"
              echo "âœ… Restored backend.tf"
            fi
            
            # 2. Restaurar outros arquivos .tf do backup
            for file in "$BACKUP_DIR"/*.tf; do
              if [ -f "$file" ]; then
                filename=$(basename "$file")
                cp "$file" "${MODULE_PATH}/${filename}"
                echo "âœ… Restored: $filename"
              fi
            done
            
            # 3. Remover backup
            rm -rf "$BACKUP_DIR"
            echo "âœ… Backup directory removed"
          fi

      - name: Upload Plan as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ steps.validate-module.outputs.MODULE_NAME }}-${{ github.run_id }}
          path: ${{ steps.validate-module.outputs.MODULE_PATH }}/tfplan
          retention-days: 7

      - name: Cleanup Test Files
        if: always()
        run: |
          cd "${{ steps.validate-module.outputs.MODULE_PATH }}"
          
          # Remover arquivos temporÃ¡rios
          rm -f test.tfvars tfplan .terraform.lock.hcl 2>/dev/null || true
          
          # Remover diretÃ³rio .terraform
          rm -rf .terraform 2>/dev/null || true
          
          echo "ğŸ§¹ Test files cleaned up"