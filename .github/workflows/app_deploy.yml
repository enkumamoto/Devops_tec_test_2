name: Deploy APP

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment name"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

jobs:
  deploy-app:
    runs-on: ubuntu-latest # Runner padr√£o = R√ÅPIDO
    needs: [aks] # S√≥ depende do AKS estar pronto
    timeout-minutes: 8 # Timeout curto

    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: "latest"

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"

      - name: Azure Login (Otimizado)
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v3
        with:
          resource-group: rg-aks-dev
          cluster-name: aks-devops-dev-dev

      - name: Verify Cluster Access
        run: |
          echo "üîç Verificando acesso ao cluster..."
          kubectl cluster-info
          kubectl get nodes
          echo "‚úÖ Cluster acess√≠vel"

      - name: Build Custom Values for Helm
        run: |
          echo "üìù Criando values.yaml customizado..."

          # Obter ACR login server dinamicamente
          ACR_LOGIN_SERVER=$(az acr show \
            -g "rg-acr-dev" \
            -n "eijidevopsdevacr" \
            --query loginServer -o tsv 2>/dev/null || echo "myacr.azurecr.io")

          cat > helm-values.yaml << EOF
          namespace: devops-app

          image:
            repository: ${ACR_LOGIN_SERVER}/fastapi-app
            tag: latest
            pullPolicy: IfNotPresent

          replicaCount: 2

          service:
            type: ClusterIP
            port: 80
            targetPort: 8000

          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi

          ingress:
            enabled: true
            className: nginx
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "false"
              nginx.ingress.kubernetes.io/proxy-body-size: "10m"
            hosts:
              - host: fastapi.devops.local
                paths:
                  - path: /
                    pathType: Prefix

          keyVault:
            enabled: false  # Para teste, desabilita CSI driver
          EOF

          echo "‚úÖ Values.yaml gerado:"
          cat helm-values.yaml

      - name: Deploy with Helm
        run: |
          echo "üöÄ Deploy com Helm..."

          # 1. Criar namespace se n√£o existir
          kubectl create namespace devops-app 2>/dev/null || echo "Namespace j√° existe"

          # 2. Instalar/Atualizar com Helm
          helm upgrade --install fastapi \
            infraestructure/helm/fastapi \
            --namespace devops-app \
            --values helm-values.yaml \
            --atomic \           # Rollback autom√°tico se falhar
            --wait \             # Aguarda pods ficarem ready
            --timeout 5m \       # Timeout curto
            --cleanup-on-fail    # Limpa se falhar

          echo "‚úÖ Helm deploy conclu√≠do"

      - name: Verify Deployment
        run: |
          echo "üìä Verificando status..."

          # Aguardar pods ready
          sleep 10

          # Status dos recursos
          echo "=== PODS ==="
          kubectl get pods -n devops-app -o wide

          echo "=== SERVICES ==="
          kubectl get svc -n devops-app

          echo "=== INGRESS ==="
          kubectl get ingress -n devops-app

          echo "=== DEPLOYMENT STATUS ==="
          kubectl rollout status deployment/fastapi -n devops-app --timeout=60s

          # Testar acesso interno
          echo "=== TESTE DE ACESSO INTERNO ==="
          kubectl run -n devops-app test-curl --image=curlimages/curl -i --rm --restart=Never -- \
            curl -s -o /dev/null -w "%{http_code}" http://fastapi-service.devops-app.svc.cluster.local:80/health || echo "Teste falhou"

      - name: Get Application URL
        run: |
          echo "üåê URLs da aplica√ß√£o:"
          echo ""
          echo "1. Interno no cluster:"
          echo "   http://fastapi-service.devops-app.svc.cluster.local"
          echo ""
          echo "2. Via Ingress (externo):"
          echo "   http://fastapi.devops.local"
          echo ""
          echo "3. Para testar localmente (port-forward):"
          echo "   kubectl port-forward -n devops-app svc/fastapi-service 8080:80"
          echo "   Acesse: http://localhost:8080"
          echo ""
          echo "‚úÖ Deploy completo em $(date +%H:%M:%S)"
